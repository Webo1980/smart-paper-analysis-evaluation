// File: src/components/dashboard/views/quality/ResearchProblemQualityView.jsx
// Research Problem Quality View - UI-only component (no calculations)
// Renders pre-aggregated data from componentData

import React, { useState } from 'react';
import { Card } from '../../../ui/card';
import { Badge } from '../../../ui/badge';
import { Alert, AlertDescription } from '../../../ui/alert';
import { 
  Target, Database, Brain, ChevronDown, ChevronUp, Info, 
  Star, TrendingUp, CheckCircle, AlertCircle, Zap, Layers
} from 'lucide-react';

/**
 * Quality Metrics Configuration
 */
const QUALITY_METRICS = {
  problemTitle: {
    key: 'problemTitle',
    label: 'Problem Title',
    description: 'How well the problem title captures the research focus',
    weight: 0.3
  },
  problemDescription: {
    key: 'problemDescription',
    label: 'Problem Description',
    description: 'Clarity and completeness of the problem description',
    weight: 0.3
  },
  relevance: {
    key: 'relevance',
    label: 'Relevance',
    description: 'How well the problem aligns with the paper content',
    weight: 0.2
  },
  completeness: {
    key: 'completeness',
    label: 'Completeness',
    description: 'Whether the problem captures all key aspects from the paper',
    weight: 0.0
  },
  evidenceQuality: {
    key: 'evidenceQuality',
    label: 'Evidence Quality',
    description: 'Quality of evidence supporting the problem formulation',
    weight: 0.2
  }
};

/**
 * Research Problem Quality View Component
 * UI-only - renders pre-aggregated data from componentData
 */
const ResearchProblemQualityView = ({ componentData, papers }) => {
  console.log("ResearchProblemQualityView received:", { componentData, papersCount: papers?.length });
  
  const [expandedSections, setExpandedSections] = useState({
    sourceBreakdown: true,
    qualityDimensions: true,
    userRatings: true,
    overallStats: true
  });

  const toggleSection = (section) => {
    setExpandedSections(prev => ({
      ...prev,
      [section]: !prev[section]
    }));
  };

  // Use componentData directly - no calculations
  const metrics = componentData;
  
  if (!metrics) {
    return (
      <Alert variant="destructive">
        <AlertCircle className="h-4 w-4" />
        <AlertDescription>
          No research problem quality data available
        </AlertDescription>
      </Alert>
    );
  }

  return (
    <div className="space-y-6 mt-4">
      {/* Source Distribution */}
      <Card className="p-6">
        <button
          onClick={() => toggleSection('sourceBreakdown')}
          className="w-full flex items-center justify-between mb-4"
        >
          <h3 className="text-lg font-semibold flex items-center gap-2">
            <Zap className="h-5 w-5 text-indigo-600" />
            Problem Source Distribution
          </h3>
          {expandedSections.sourceBreakdown ? (
            <ChevronUp className="h-5 w-5 text-gray-400" />
          ) : (
            <ChevronDown className="h-5 w-5 text-gray-400" />
          )}
        </button>

        {expandedSections.sourceBreakdown && metrics.sourceDistribution && (
          <div className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <SourceCard
                icon={Database}
                title="ORKG Problems"
                count={metrics.sourceDistribution.orkg}
                percentage={metrics.sourceDistribution.total > 0 
                  ? (metrics.sourceDistribution.orkg / metrics.sourceDistribution.total * 100).toFixed(1)
                  : 0}
                color="blue"
                description="From ORKG database"
                qualityScore={metrics.bySource?.orkg?.overall?.mean}
              />
              <SourceCard
                icon={Brain}
                title="LLM Generated"
                count={metrics.sourceDistribution.llm}
                percentage={metrics.sourceDistribution.total > 0 
                  ? (metrics.sourceDistribution.llm / metrics.sourceDistribution.total * 100).toFixed(1)
                  : 0}
                color="purple"
                description="Generated by AI"
                qualityScore={metrics.bySource?.llm?.overall?.mean}
              />
              <SourceCard
                icon={Target}
                title="Total Evaluations"
                count={metrics.sourceDistribution.total}
                percentage="100.0"
                color="green"
                description="All evaluated problems"
                qualityScore={metrics.qualityScores?.overall?.mean}
              />
            </div>

            <Alert className="bg-blue-50 border-blue-200">
              <Info className="h-4 w-4" />
              <AlertDescription>
                <p className="text-sm">
                  <strong>Source Types:</strong> Research problems can be either retrieved from the ORKG database 
                  (existing problems) or generated by the LLM (new problems identified from paper content).
                </p>
              </AlertDescription>
            </Alert>
          </div>
        )}
      </Card>

      {/* Overall Quality Statistics */}
      <Card className="p-6">
        <button
          onClick={() => toggleSection('overallStats')}
          className="w-full flex items-center justify-between mb-4"
        >
          <h3 className="text-lg font-semibold flex items-center gap-2">
            <TrendingUp className="h-5 w-5 text-green-600" />
            Overall Quality Statistics
          </h3>
          {expandedSections.overallStats ? (
            <ChevronUp className="h-5 w-5 text-gray-400" />
          ) : (
            <ChevronDown className="h-5 w-5 text-gray-400" />
          )}
        </button>

        {expandedSections.overallStats && metrics.qualityScores && (
          <div className="space-y-6">
            {/* Combined Quality Scores */}
            {metrics.qualityScores.overall && (
              <div>
                <h4 className="text-sm font-semibold text-gray-900 mb-3">Combined Quality Scores (Final)</h4>
                <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                  <StatCard label="Mean Score" value={metrics.qualityScores.overall.mean} type="score" />
                  <StatCard label="Std Dev" value={metrics.qualityScores.overall.std} type="number" decimals={3} />
                  <StatCard label="Min Score" value={metrics.qualityScores.overall.min} type="score" />
                  <StatCard label="Max Score" value={metrics.qualityScores.overall.max} type="score" />
                  <StatCard label="Median" value={metrics.qualityScores.overall.median} type="score" />
                </div>
              </div>
            )}

            {/* Automated Quality Scores */}
            {metrics.qualityScores.automated && (
              <div>
                <h4 className="text-sm font-semibold text-gray-900 mb-3">Automated Quality Scores</h4>
                <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                  <StatCard label="Mean Score" value={metrics.qualityScores.automated.mean} type="score" />
                  <StatCard label="Std Dev" value={metrics.qualityScores.automated.std} type="number" decimals={3} />
                  <StatCard label="Min Score" value={metrics.qualityScores.automated.min} type="score" />
                  <StatCard label="Max Score" value={metrics.qualityScores.automated.max} type="score" />
                  <StatCard label="Median" value={metrics.qualityScores.automated.median} type="score" />
                </div>
              </div>
            )}

            {/* Quality by Source */}
            {(metrics.bySource?.orkg?.overall || metrics.bySource?.llm?.overall) && (
              <div>
                <h4 className="text-sm font-semibold text-gray-900 mb-3">Quality by Source</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {metrics.bySource.orkg?.overall && (
                    <Card className="p-4 bg-blue-50">
                      <div className="flex items-center gap-2 mb-3">
                        <Database className="h-5 w-5 text-blue-600" />
                        <h5 className="font-semibold text-blue-900">ORKG Problems</h5>
                      </div>
                      <div className="space-y-2">
                        <StatRow label="Mean" value={metrics.bySource.orkg.overall.mean} type="score" />
                        <StatRow label="Std Dev" value={metrics.bySource.orkg.overall.std} type="number" />
                        <StatRow label="Count" value={metrics.bySource.orkg.overall.count} type="count" />
                      </div>
                    </Card>
                  )}

                  {metrics.bySource.llm?.overall && (
                    <Card className="p-4 bg-purple-50">
                      <div className="flex items-center gap-2 mb-3">
                        <Brain className="h-5 w-5 text-purple-600" />
                        <h5 className="font-semibold text-purple-900">LLM Generated</h5>
                      </div>
                      <div className="space-y-2">
                        <StatRow label="Mean" value={metrics.bySource.llm.overall.mean} type="score" />
                        <StatRow label="Std Dev" value={metrics.bySource.llm.overall.std} type="number" />
                        <StatRow label="Count" value={metrics.bySource.llm.overall.count} type="count" />
                      </div>
                    </Card>
                  )}
                </div>
              </div>
            )}
          </div>
        )}
      </Card>

      {/* Quality Dimensions */}
      {metrics.dimensionScores && (
        <Card className="p-6">
          <button
            onClick={() => toggleSection('qualityDimensions')}
            className="w-full flex items-center justify-between mb-4"
          >
            <h3 className="text-lg font-semibold flex items-center gap-2">
              <CheckCircle className="h-5 w-5 text-blue-600" />
              Quality Dimensions
            </h3>
            {expandedSections.qualityDimensions ? (
              <ChevronUp className="h-5 w-5 text-gray-400" />
            ) : (
              <ChevronDown className="h-5 w-5 text-gray-400" />
            )}
          </button>

          {expandedSections.qualityDimensions && (
            <div className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {Object.entries(QUALITY_METRICS).map(([key, metric]) => {
                  const dimScores = metrics.dimensionScores[key];
                  if (!dimScores) return null;

                  return (
                    <DimensionCard
                      key={key}
                      label={metric.label}
                      description={metric.description}
                      finalScore={dimScores.final?.mean}
                      automatedScore={dimScores.automated?.mean}
                      weight={metric.weight}
                    />
                  );
                })}
              </div>

              <div className="p-4 bg-gray-50 rounded border">
                <h4 className="text-sm font-semibold text-gray-900 mb-3">Quality Dimension Weights</h4>
                <div className="space-y-2">
                  {Object.entries(QUALITY_METRICS)
                    .filter(([_, metric]) => metric.weight > 0)
                    .map(([key, metric]) => (
                      <div key={key} className="flex items-center justify-between text-sm">
                        <span className="text-gray-700">{metric.label}</span>
                        <div className="flex items-center gap-2">
                          <div className="w-32 bg-gray-200 rounded-full h-2">
                            <div
                              className="bg-blue-500 h-2 rounded-full"
                              style={{ width: `${metric.weight * 100}%` }}
                            />
                          </div>
                          <span className="text-gray-900 font-mono w-12 text-right">
                            {(metric.weight * 100).toFixed(0)}%
                          </span>
                        </div>
                      </div>
                    ))}
                </div>
              </div>
            </div>
          )}
        </Card>
      )}

      {/* User Ratings */}
      {metrics.userRatings && Object.keys(metrics.userRatings).length > 0 && (
        <Card className="p-6">
          <button
            onClick={() => toggleSection('userRatings')}
            className="w-full flex items-center justify-between mb-4"
          >
            <h3 className="text-lg font-semibold flex items-center gap-2">
              <Star className="h-5 w-5 text-yellow-600" />
              User Ratings Distribution
            </h3>
            {expandedSections.userRatings ? (
              <ChevronUp className="h-5 w-5 text-gray-400" />
            ) : (
              <ChevronDown className="h-5 w-5 text-gray-400" />
            )}
          </button>

          {expandedSections.userRatings && (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {Object.entries(metrics.userRatings).map(([key, stats]) => {
                if (!stats || stats.count === 0) return null;
                
                const metric = QUALITY_METRICS[key] || { 
                  label: key === 'overallAssessment' ? 'Overall Assessment' : key, 
                  description: '' 
                };
                
                return (
                  <UserRatingCard
                    key={key}
                    label={metric.label || formatLabel(key)}
                    stats={stats}
                    description={metric.description}
                  />
                );
              })}
            </div>
          )}
        </Card>
      )}

      {/* Evaluation Summary */}
      <Card className="p-4 bg-gradient-to-r from-indigo-50 to-purple-50">
        <div className="flex items-center justify-between">
          <div>
            <p className="text-sm text-gray-600 mb-1">Total Evaluations</p>
            <p className="text-3xl font-bold text-indigo-700">
              {metrics.evaluationCount || metrics.sourceDistribution?.total || 0}
            </p>
          </div>
          <Info className="h-8 w-8 text-indigo-400" />
        </div>
      </Card>
    </div>
  );
};

// Sub-Components
const SourceCard = ({ icon: Icon, title, count, percentage, color, description, qualityScore }) => {
  const colorClasses = {
    blue: 'bg-blue-50 border-blue-200 text-blue-700',
    purple: 'bg-purple-50 border-purple-200 text-purple-700',
    green: 'bg-green-50 border-green-200 text-green-700'
  };

  return (
    <Card className={`p-4 ${colorClasses[color]}`}>
      <div className="flex items-center gap-3 mb-3">
        <Icon className="h-6 w-6" />
        <h4 className="font-semibold">{title}</h4>
      </div>
      <div className="text-3xl font-bold mb-1">{count}</div>
      <div className="text-xl font-semibold mb-2">{percentage}%</div>
      {qualityScore !== undefined && qualityScore !== null && (
        <div className="text-sm font-medium mb-2">
          Quality: {formatPercentage(qualityScore)}
        </div>
      )}
      <p className="text-xs opacity-80">{description}</p>
    </Card>
  );
};

const StatCard = ({ label, value, type, decimals = 2 }) => {
  const formatValue = () => {
    if (value === null || value === undefined) return 'N/A';
    if (type === 'score') return formatPercentage(value);
    if (type === 'count') return value.toString();
    return value.toFixed(decimals);
  };

  return (
    <Card className="p-4 text-center">
      <p className="text-xs text-gray-600 mb-1">{label}</p>
      <p className={`text-2xl font-bold ${type === 'score' ? getScoreColor(value) : 'text-gray-900'}`}>
        {formatValue()}
      </p>
    </Card>
  );
};

const StatRow = ({ label, value, type, decimals = 2 }) => {
  const formatValue = () => {
    if (value === null || value === undefined) return 'N/A';
    if (type === 'score') return formatPercentage(value);
    if (type === 'count') return value.toString();
    return value.toFixed(decimals);
  };

  return (
    <div className="flex justify-between items-center text-sm">
      <span className="text-gray-700">{label}:</span>
      <span className={`font-semibold ${type === 'score' ? getScoreColor(value) : 'text-gray-900'}`}>
        {formatValue()}
      </span>
    </div>
  );
};

const DimensionCard = ({ label, description, finalScore, automatedScore, weight }) => {
  const improvement = (finalScore !== undefined && automatedScore !== undefined) 
    ? finalScore - automatedScore 
    : null;

  return (
    <Card className="p-4">
      <div className="flex items-center justify-between mb-2">
        <h5 className="text-sm font-semibold text-gray-900">{label}</h5>
        {weight > 0 && (
          <Badge variant="outline" className="text-xs">
            {(weight * 100).toFixed(0)}%
          </Badge>
        )}
      </div>

      <div className="space-y-2 mb-3">
        {finalScore !== undefined && finalScore !== null && (
          <div className="flex items-center justify-between">
            <span className="text-xs text-gray-600">Final Score:</span>
            <span className={`text-lg font-bold ${getScoreColor(finalScore)}`}>
              {formatPercentage(finalScore)}
            </span>
          </div>
        )}
        {automatedScore !== undefined && automatedScore !== null && (
          <div className="flex items-center justify-between">
            <span className="text-xs text-gray-600">Automated:</span>
            <span className={`text-sm font-medium ${getScoreColor(automatedScore)}`}>
              {formatPercentage(automatedScore)}
            </span>
          </div>
        )}
        {improvement !== null && (
          <div className="flex items-center justify-between pt-1 border-t">
            <span className="text-xs text-gray-600">Improvement:</span>
            <span className={`text-sm font-semibold ${improvement >= 0 ? 'text-green-600' : 'text-red-600'}`}>
              {improvement >= 0 ? '+' : ''}{formatPercentage(improvement)}
            </span>
          </div>
        )}
      </div>

      <p className="text-xs text-gray-600">{description}</p>
    </Card>
  );
};

const UserRatingCard = ({ label, stats, description }) => {
  return (
    <Card className="p-4">
      <h5 className="text-sm font-semibold text-gray-900 mb-2">{label}</h5>
      
      <div className="space-y-2 mb-3">
        <div className="flex items-center justify-between">
          <span className="text-xs text-gray-600">Mean:</span>
          <span className={`text-lg font-bold ${getRatingColor(stats.mean)}`}>
            {formatRating(stats.mean)} / 5
          </span>
        </div>
        <div className="flex items-center justify-between text-xs">
          <span className="text-gray-600">Range:</span>
          <span className="text-gray-900 font-medium">
            {formatRating(stats.min)} - {formatRating(stats.max)}
          </span>
        </div>
        <div className="flex items-center justify-between text-xs">
          <span className="text-gray-600">Ratings:</span>
          <span className="text-gray-900 font-medium">{stats.count}</span>
        </div>
      </div>

      {description && (
        <p className="text-xs text-gray-600">{description}</p>
      )}
    </Card>
  );
};

// Helper Functions
function formatPercentage(value) {
  if (value === null || value === undefined || isNaN(value)) return 'N/A';
  return `${(value * 100).toFixed(1)}%`;
}

function formatRating(value) {
  if (value === null || value === undefined || isNaN(value)) return 'N/A';
  return value.toFixed(1);
}

function formatLabel(key) {
  return key
    .replace(/([A-Z])/g, ' $1')
    .replace(/^./, str => str.toUpperCase())
    .trim();
}

function getScoreColor(score) {
  if (score === null || score === undefined || isNaN(score)) return 'text-gray-400';
  if (score >= 0.8) return 'text-green-600';
  if (score >= 0.6) return 'text-blue-600';
  if (score >= 0.4) return 'text-yellow-600';
  return 'text-red-600';
}

function getRatingColor(rating) {
  if (rating >= 4) return 'text-green-600';
  if (rating >= 3) return 'text-blue-600';
  if (rating >= 2) return 'text-yellow-600';
  return 'text-red-600';
}

export default ResearchProblemQualityView;